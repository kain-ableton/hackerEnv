#!/bin/bash
# modules/post_exploitation.sh - Post-Exploitation Module
# Version: 2.0

set -euo pipefail

source "$(dirname "${BASH_SOURCE[0]}")/../lib/utils.sh"

MODULE_NAME="POST_EXPLOIT"
MODULE_VERSION="2.0"

# Extract interesting information from scan results
function post_extract_credentials() {
    local target_dir="$1"
    local creds_file="${target_dir}/found_credentials.txt"
    
    log_info "[$MODULE_NAME] Extracting found credentials..."
    
    {
        echo "=========================================="
        echo "FOUND CREDENTIALS"
        echo "=========================================="
        echo "Date: $(date '+%Y-%m-%d %H:%M:%S')"
        echo ""
        
        # From Hydra
        if [ -d "${target_dir}/hydra" ]; then
            echo "=== Hydra Brute Force ==="
            for bf_file in "${target_dir}/hydra"/*_bruteforce.txt; do
                if [ -f "$bf_file" ] && grep -q "login:" "$bf_file" 2>/dev/null; then
                    local service
                    service=$(basename "$bf_file" _bruteforce.txt)
                    echo ""
                    echo "Service: ${service^^}"
                    grep "login:" "$bf_file"
                fi
            done
        fi
        
        # From nmap scripts
        echo ""
        echo "=== Nmap Scripts ==="
        if find "$target_dir" -name "*.xml" -o -name "*.nmap" | xargs grep -ih "password\|credential\|login\|user" 2>/dev/null | grep -v "^#" | head -20; then
            :
        else
            echo "No credentials found in nmap output"
        fi
        
        # From toolchains
        echo ""
        echo "=== Toolchain Results ==="
        if find "$target_dir"/*_toolchain -type f 2>/dev/null | xargs grep -ih "password\|credential\|user.*:" 2>/dev/null | grep -v "^#" | head -20; then
            :
        else
            echo "No credentials found in toolchain output"
        fi
        
    } > "$creds_file"
    
    log_success "[$MODULE_NAME] Credentials extracted: $creds_file"
}

# Extract open ports and services
function post_extract_services() {
    local target_dir="$1"
    local services_summary="${target_dir}/services_summary.txt"
    local target
    target=$(basename "$target_dir")
    
    log_info "[$MODULE_NAME] Generating services summary..."
    
    {
        echo "=========================================="
        echo "SERVICES SUMMARY"
        echo "=========================================="
        echo "Target: $target"
        echo "Date: $(date '+%Y-%m-%d %H:%M:%S')"
        echo ""
        
        if [ -f "${target_dir}/nmap_${target}.nmap" ]; then
            echo "Open Ports and Services:"
            echo ""
            grep "open" "${target_dir}/nmap_${target}.nmap" | grep -v "Warning" | while read -r line; do
                echo "  $line"
            done
        fi
        
        echo ""
        echo "Services List:"
        if [ -f "${target_dir}/services.txt" ]; then
            while IFS= read -r service; do
                echo "  - $service"
            done < "${target_dir}/services.txt"
        fi
        
    } > "$services_summary"
    
    log_success "[$MODULE_NAME] Services summary: $services_summary"
}

# Extract vulnerability information
function post_extract_vulnerabilities() {
    local target_dir="$1"
    local vulns_file="${target_dir}/vulnerabilities.txt"
    
    log_info "[$MODULE_NAME] Extracting vulnerability information..."
    
    {
        echo "=========================================="
        echo "VULNERABILITY REPORT"
        echo "=========================================="
        echo "Date: $(date '+%Y-%m-%d %H:%M:%S')"
        echo ""
        
        echo "=== CVEs and Known Vulnerabilities ==="
        if find "$target_dir" -type f | xargs grep -ih "CVE-[0-9]\{4\}-[0-9]\+" 2>/dev/null | sort -u; then
            :
        else
            echo "No CVEs found"
        fi
        
        echo ""
        echo "=== Vulnerability Keywords ==="
        if find "$target_dir" -type f | xargs grep -ioh "vulnerable\|exploit.*\|backdoor\|weak.*\|insecure.*" 2>/dev/null | sort | uniq -c | sort -rn | head -20; then
            :
        else
            echo "No vulnerability keywords found"
        fi
        
        echo ""
        echo "=== Security Issues ==="
        # Check for common issues
        if grep -q "telnet" "${target_dir}/services.txt" 2>/dev/null; then
            echo "  ⚠️ Telnet service detected (unencrypted)"
        fi
        if grep -q "ftp" "${target_dir}/services.txt" 2>/dev/null; then
            echo "  ⚠️ FTP service detected (potentially unencrypted)"
        fi
        if grep -iq "anonymous" "$target_dir" 2>/dev/null; then
            echo "  ⚠️ Anonymous access may be enabled"
        fi
        
    } > "$vulns_file"
    
    log_success "[$MODULE_NAME] Vulnerabilities extracted: $vulns_file"
}

# Generate attack surface analysis
function post_attack_surface() {
    local target_dir="$1"
    local attack_surface_file="${target_dir}/attack_surface.txt"
    local target
    target=$(basename "$target_dir")
    
    log_info "[$MODULE_NAME] Analyzing attack surface..."
    
    local port_count=0
    local service_count=0
    local web_services=0
    local remote_access=0
    local file_services=0
    
    # Count services
    if [ -f "${target_dir}/services.txt" ]; then
        service_count=$(wc -l < "${target_dir}/services.txt")
        web_services=$(grep -c "http\|https" "${target_dir}/services.txt" 2>/dev/null || echo "0")
        remote_access=$(grep -c "ssh\|telnet\|rdp\|vnc" "${target_dir}/services.txt" 2>/dev/null || echo "0")
        file_services=$(grep -c "ftp\|smb\|nfs" "${target_dir}/services.txt" 2>/dev/null || echo "0")
    fi
    
    if [ -f "${target_dir}/nmap_${target}.nmap" ]; then
        port_count=$(grep -c "open" "${target_dir}/nmap_${target}.nmap" 2>/dev/null || echo "0")
    fi
    
    # Calculate risk score (simple)
    local risk_score=0
    risk_score=$((risk_score + port_count * 2))
    risk_score=$((risk_score + remote_access * 10))
    risk_score=$((risk_score + web_services * 5))
    
    local risk_level="LOW"
    if [ $risk_score -gt 50 ]; then
        risk_level="HIGH"
    elif [ $risk_score -gt 20 ]; then
        risk_level="MEDIUM"
    fi
    
    {
        echo "=========================================="
        echo "ATTACK SURFACE ANALYSIS"
        echo "=========================================="
        echo "Target: $target"
        echo "Date: $(date '+%Y-%m-%d %H:%M:%S')"
        echo ""
        echo "SUMMARY:"
        echo "  Open Ports:        $port_count"
        echo "  Total Services:    $service_count"
        echo "  Web Services:      $web_services"
        echo "  Remote Access:     $remote_access"
        echo "  File Services:     $file_services"
        echo ""
        echo "RISK ASSESSMENT:"
        echo "  Risk Score:        $risk_score"
        echo "  Risk Level:        $risk_level"
        echo ""
        echo "ATTACK VECTORS:"
        [ $web_services -gt 0 ] && echo "  • Web Application Attacks (SQL injection, XSS, CSRF)"
        [ $remote_access -gt 0 ] && echo "  • Brute Force / Credential Attacks"
        [ $file_services -gt 0 ] && echo "  • File Transfer Protocol Exploits"
        if grep -q "database\|mysql\|postgres" "${target_dir}/services.txt" 2>/dev/null; then
            echo "  • Database Attacks"
        fi
        echo ""
        echo "RECOMMENDATIONS:"
        echo "  1. Minimize exposed services"
        echo "  2. Implement strong authentication"
        echo "  3. Use encryption for all services"
        echo "  4. Regular security updates"
        echo "  5. Network segmentation"
        
    } > "$attack_surface_file"
    
    log_success "[$MODULE_NAME] Attack surface analysis: $attack_surface_file"
}

# Main post-exploitation module
function post_exploitation_main() {
    local target_dir="$1"
    
    log_info "[$MODULE_NAME] Starting post-exploitation analysis..."
    
    # Extract all useful information
    post_extract_credentials "$target_dir" || true
    post_extract_services "$target_dir" || true
    post_extract_vulnerabilities "$target_dir" || true
    post_attack_surface "$target_dir" || true
    
    log_success "[$MODULE_NAME] Post-exploitation analysis complete"
}

# Export functions
export -f post_extract_credentials post_extract_services
export -f post_extract_vulnerabilities post_attack_surface
export -f post_exploitation_main
